---
import { getCollection } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import BlogCard from '../../components/BlogCard.astro'
import Pagination from '../../components/Pagination.astro'

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection('blog')

  // Filter out drafts and sort by date (newest first)
  const publishedPosts = allPosts
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())

  // Generate paginated pages
  return paginate(publishedPosts, {
    pageSize: 6,
  })
}

const { page } = Astro.props

// Get featured posts for the sidebar (only on first page)
const allPosts = await getCollection('blog')
const featuredPosts =
  page.currentPage === 1
    ? allPosts
        .filter((post) => !post.data.draft && post.data.featured)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
        .slice(0, 3)
    : []

const pageTitle =
  page.currentPage === 1
    ? 'Blog - Android Development & Tech Articles'
    : `Blog - Trang ${page.currentPage}`

const pageDescription =
  'Chia sẻ kiến thức về Android, Clean Architecture, Jetpack Compose, và các công nghệ mobile hiện đại.'
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="mx-auto max-w-3xl px-4 py-12">
    <!-- Page Header -->
    <div class="mb-12">
      <h1 class="text-3xl font-serif font-semibold text-gray-900 dark:text-gray-100">
        Blog
      </h1>
    </div>

    {/* Blog Posts */}
    {
      page.data.length > 0 ? (
        <>
          <div class="space-y-0">
            {page.data.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>

          {page.lastPage > 1 && (
            <div class="mt-12">
              <Pagination page={page} />
            </div>
          )}
        </>
      ) : (
        <p class="text-gray-500">No posts yet.</p>
      )
    }
  </div>
</BaseLayout>
